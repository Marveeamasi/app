<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preview</title>
  <meta name="description" content="Your Number 1 Video Dual App - Preview">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/global.css">
  <style>
    /* Import Pacifico font as fallback */
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
 
    /* Reset default browser styles */
    button, a, h1, h2, h3, h4, h5, h6, input, textarea, ul, ol {
      all: unset;
      box-sizing: border-box;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    button {
      cursor: pointer;
    }
    input, textarea {
      background: transparent;
      color: inherit;
    }
    
    .dynamic{
      color: #FCE340;
      font-family: 'Pacifico', cursive;
    }
    .documentary{
      font-size: 8px;
      font-style: italic;
      font-weight: 800;
      width: 80px;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    /* Main container */
    .main-container {
      display: flex;
      width: 100%;
      height: 100%;
      min-height: 100vh;
      transition: all 0.3s ease-in-out;
    }

    /* Sidebar */
    .sidebar {
      background: #261148;
      width: fit-content;
      height: 100vh;
      padding-top: 40px;
      padding-left: 20px;
      padding-bottom: 20px;
      padding-right: 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
      font-weight: 500;
      font-size: 16px;
      position: sticky;
      left: 0;
      top: 0;
      z-index: 30;
      transition: all 0.3s ease-in-out;
    }
    @media (max-width: 1024px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        background: transparent;
        backdrop-filter: blur(4px);
        padding-left: 0;
      }
    }
    .sidebar-logo {
      width: 214px;
      height: 44px;
    }
    @media (max-width: 1024px) {
      .sidebar-logo {
        display: none;
      }
    }
    .sidebar-content {
      overflow-y: scroll;
      overflow-x: hidden;
    }
    @media (max-width: 1024px) {
      .sidebar-content {
        padding-top: 70px;
      }
    }
    .sidebar-panel {
      background: #140926;
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 295px;
      position: relative;
    }
    @media (max-width: 1024px) {
      .sidebar-panel {
        background: rgba(20, 9, 38, 0.75);
        border: 1px solid rgba(255, 255, 255, 0.09);
        backdrop-filter: blur(4px);
      }
    }
    .sidebar-select {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }
    .sidebar-select-label {
      font-size: 12.51px;
      font-weight: 700;
    }
    .sidebar-select-button {
      border-radius: 4px;
      padding: 12px;
      width: 100%;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12.51px;
      background: #261148;
      cursor: pointer;
    }
    .sidebar-select-button.dynamic {
      font-family: 'Pacifico', cursive;
      color: #FCE340;
      font-size: 12px;
      font-weight: 400;
    }
    .sidebar-select-button.professional {
      font-size: 14px;
      font-weight: 700;
    }
    .sidebar-select-button.documentary {
      font-size: 14px;
      font-weight: 800;
      font-style: italic;
    }
    .sidebar-select-button img {
      width: 24px;
      height: 24px;
    }
    .sidebar-select-dropdown {
      display: none;
      position: absolute;
      background: #140926;
      width: 285px;
      left: -5%;
      border-radius: 8px;
      gap: 12px;
      flex-direction: column;
      border: 1px solid #CF36E9;
      padding: 20px 9px;
      z-index: 50;
    }
    .sidebar-select-dropdown.show {
      display: flex;
    }
    .sidebar-select-dropdown.top {
      top: 110%;
    }
    .sidebar-select-dropdown.bottom {
      bottom: 110%;
    }
    .sidebar-select-dropdown-header {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .sidebar-select-dropdown-header img {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .sidebar-select-dropdown-search {
      background: #140926;
      width: 100%;
      height: 35px;
      border: 1px solid rgba(140, 140, 140, 0.5);
      border-radius: 4px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-select-dropdown-search:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-search img {
      width: 16px;
      height: 16px;
    }
    .sidebar-select-dropdown-search input {
      font-size: 10px;
      font-weight: 400;
      color: white;
      outline: none;
      width: 100%;
    }
    .sidebar-select-dropdown-search input::placeholder {
      color: #8C8C8C;
    }
    .avatar-toggle-switch {
  display: flex;
  width: 100%;
  border-radius: 8px;
  overflow: hidden;
  background: #CF36E9;
  padding: 5px;
  gap: 5px;
}
.toggle-option {
  flex: 1;
  background: transparent;
  color: white;
  font-size: 12px;
  font-weight: 400;
  border: none;
  cursor: pointer;
  transition: background 0.3s ease;
  border-radius: 8px;
  text-align: center;
  height: 35px;
}
.toggle-option-active {
  background: #140926;
}
.toggle-option:hover {
  background: #140926;
}
    .sidebar-select-dropdown-options {
      display: grid;
      gap: 8px;
    }
    .sidebar-select-dropdown-option {
      background: #261148;
      border-radius: 4px;
      padding: 12px;
      font-size: 12.51px;
      font-weight: 400;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    .sidebar-select-dropdown-option:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-option img {
      width: 20px;
      height: 20px;
    }
    .sidebar-select-dropdown-option.dynamic {
      font-family: 'Pacifico', cursive;
      color: #FCE340;
      font-size: 12px;
      font-weight: 400;
    }
    .sidebar-select-dropdown-option.professional {
      font-size: 14px;
      font-weight: 700;
    }
    .sidebar-select-dropdown-option.documentary {
      font-size: 14px;
      font-weight: 800;
      font-style: italic;
    }
    .sidebar-select-dropdown-avatar-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .sidebar-select-dropdown-avatar-option {
      background: #140926;
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      font-size: 12.51px;
      font-weight: 400;
    }
    .sidebar-select-dropdown-avatar-option:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-avatar-option img {
      width: 124px;
      height: 130px;
      object-fit: cover;
      border-radius: 4px;
    }
    .sidebar-select-dropdown-avatar-option-text {
      position: absolute;
      bottom: 0;
      width: 100%;
      padding: 8px;
      text-align: center;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.09) 0%, #000000 100%);
    }
    .sidebar-select-dropdown-camera-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .sidebar-select-dropdown-camera-option {
      background: #140926;
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      cursor: pointer;
      font-size: 12.51px;
      font-weight: 400;
    }
    .sidebar-select-dropdown-camera-option:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-camera-option img {
      width: 100%;
      height: 130px;
      object-fit: cover;
      border-radius: 4px;
    }
    .sidebar-select-dropdown-camera-option-text {
      position: absolute;
      bottom: 0;
      width: 100%;
      padding: 12px;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.09) 0%, #000000 100%);
    }
    .sidebar-select-dropdown-background-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }
    .sidebar-select-dropdown-background-option {
      background: #261148;
      border-radius: 4px;
      padding: 12px;
      font-size: 10px;
      font-weight: 400;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      height: 78px;
    }
    .sidebar-select-dropdown-background-option.upload {
      flex-direction: column;
      gap: 8px;
    }
    .sidebar-select-dropdown-background-option:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-background-option img {
      width: 24px;
      height: 24px;
    }
    .sidebar-select-dropdown-caption-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
    }
    .sidebar-select-dropdown-caption-options-position {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sidebar-select-dropdown-caption-options-position-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .sidebar-select-dropdown-caption-options-position-button {
      background: #261148;
      border-radius: 4px;
      height: 35px;
      font-size: 12px;
      font-weight: 400;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .sidebar-select-dropdown-caption-options-position-button:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-caption-options-size {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sidebar-select-dropdown-caption-options-size-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .sidebar-select-dropdown-caption-options-size-button {
      background: #261148;
      border-radius: 4px;
      height: 35px;
      font-size: 12px;
      font-weight: 400;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .sidebar-select-dropdown-caption-options-size-button:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-select-dropdown-music-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
    }
    .sidebar-select-dropdown-music-progress {
      width: 100%;
      height: 6px;
      background: #D9D9D9;
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }
    .sidebar-select-dropdown-music-progress-bar {
      height: 100%;
      background: #9413E6;
      border-radius: 16px;
    }
    .sidebar-select-dropdown-music-progress-thumb {
      position: absolute;
      width: 9px;
      height: 9px;
      background: #5500FF;
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 50%;
      top: -2px;
    }
    .sidebar-select-dropdown-voice-buttons {
      display: flex;
      justify-content: space-between;
      gap: 5px;
    }
    .sidebar-select-dropdown-voice-button {
      background: #261148;
      border-radius: 4px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 50%;
      cursor: pointer;
    }
    .sidebar-select-dropdown-voice-button img {
      width: 20px;
      height: 20px;
    }
    .sidebar-select-dropdown-voice-button-list {
      display: none;
      position: absolute;
      background: #261148;
      border-radius: 8px;
      padding: 10px 5px;
      gap: 5px;
      flex-direction: column;
      width: 150px;
      z-index: 50;
      top: 150px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .sidebar-select-dropdown-voice-button-list.show {
      display: flex;
    }
    .sidebar-select-dropdown-voice-button-list.left {
      left: 0;
    }
    .sidebar-select-dropdown-voice-button-list.right {
      right: 0;
    }
    .sidebar-select-dropdown-voice-button-option {
      background: #140926;
      border-radius: 4px;
      padding: 10px 12px;
      font-size: 12.51px;
      font-weight: 400;
      cursor: pointer;
    }
    .sidebar-select-dropdown-voice-button-option:hover {
      border: 1px solid #CF36E9;
    }
    .sidebar-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12.51px;
      font-weight: 700;
      position: relative;
    }
    .sidebar-toggle-switch {
      position: relative;
      display: inline-flex;
      width: 41px;
      height: 20px;
      align-items: center;
      border-radius: 9999px;
      transition: background 0.2s;
      cursor: pointer;
    }
    .sidebar-toggle-switch.on {
      background: #9413E6;
    }
    .sidebar-toggle-switch.off {
      background: gray;
    }
    .sidebar-toggle-switch-circle {
      display: inline-block;
      width: 16.57px;
      height: 16.57px;
      background: white;
      border-radius: 9999px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s;
    }
    .sidebar-toggle-switch-circle.on {
      transform: translateX(24px);
    }
    .sidebar-toggle-switch-circle.off {
      transform: translateX(0);
    }
    .sidebar-blur {
      display: none;
      position: absolute;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(2px);
      z-index: 20;
    }
    .sidebar-blur.show {
      display: block;
    }

    /* Main content */
    .main-content {
      width: 100%;
      min-height: 100vh;
      position: relative;
    }

     /* Background images */
     .bg-top {
      position: absolute;
      right: 0;
      top: 0;
      z-index: 0;
      width: 372px;
      height: auto;
    }
    .bg-bottom {
      position: absolute;
      left: 0;
      bottom: 0;
      z-index: 0;
      width: 532px;
      height: auto;
    }

    @media (max-width: 600px){
      .bg-top, .bg-bottom{
         display: none;
      }
    }


    /* Navbar */
    .navbar {
      position: sticky;
      top: 0;
      display: flex;
      justify-content: space-between;
      padding: 20px 20px 20px 20px;
      font-size: 24px;
      font-weight: 500;
      align-items: center;
      background: #261148;
      z-index: 50;
    }
    @media (max-width: 640px) {
      .navbar {
        font-size: 12px;
      }
    }
    .navbar-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-title img {
      width: 24px;
      height: 24px;
      cursor: pointer;
      transition: all 0.3s ease-in-out;
    }
    @media (min-width: 1025px) {
      .navbar-title img {
        display: none;
      }
    }
    .navbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-actions-preview {
      background: #140926;
      width: 261px;
      height: 49px;
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 16px;
      font-weight: 500;
    }
    @media (max-width: 640px) {
      .navbar-actions-preview {
        width: fit-content;
        padding: 8px 20px;
        height: fit-content;
        font-size: 12px;
      }
    }
    .navbar-actions img {
      width: 24px;
      height: 24px;
    }

    /* Main preview */
    .preview-main {
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-bottom: 160px;
      gap: 12px;
      align-items: center;
      position: relative;
      z-index: 5;
    }
    .preview-textarea {
      width: 100%;
      height: 193px;
      background: #140926;
      border-radius: 8px;
      padding: 20px;
      font-size: 12px;
      font-weight: 400;
      color: white;
      resize: none;
      outline: none;
    }
    @media (max-width: 640px) {
      .preview-textarea {
        height: 150px;
      }
    }
    .preview-textarea::placeholder {
      color: #D9D9D9;
    }
    .preview-video-container {
      background: black;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease-in-out;
      overflow: hidden;
      position: relative;
    }
      
    .preview-video-container.landscape {
      width: 100%;
      height: 454px;
      border-radius: 66px;
    }
    .preview-video-container.portrait {
      width: 323px;
      height: 454px;
      border-radius: 15px;
    }
    @media (max-width: 640px) {
      .preview-video-container.landscape {
        height: 180px;
        border-radius: 20px;
      }
      .preview-video-container.portrait {
        width: 200px;
        height: 320px;
        border-radius: 10px;
      }
    }
    .preview-video-container video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: inherit;
    }
    .preview-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0 20px;
    }
    @media (max-width: 640px) {
      .preview-controls {
        flex-direction: column;
        gap: 20px;
        justify-content: center;
      }
    }
    .preview-controls-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .preview-controls-left {
        width: 100%;
        justify-content: space-between;
      }
    }
    .preview-controls-left-orientation {
      display: flex;
      align-items: center;
      padding: 4px;
      border-radius: 4px;
      background: white;
      color: #9413E6;
      font-size: 12px;
      gap: 12px;
      cursor: pointer;
    }
    .preview-controls-left-orientation img {
      width: 16px;
      height: 16px;
    }
    .preview-controls-left-add-image img {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    .preview-controls-left-add-image img:hover {
      animation: pulse 1s infinite;
    }
    .preview-controls-center {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @media (max-width: 640px) {
      .preview-controls-center {
        gap: 40px;
      }
    }
    .preview-controls-center img {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .preview-controls-center img:hover {
      animation: pulse 1s infinite;
    }
    .preview-controls-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      color: #8C8C8C;
      font-size: 12px;
      width: 150px;
    }
    .preview-timeline {
      background: #1D1920;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      width: 100%;
      position: relative;
    }
    .preview-timeline-container {
      position: relative;
      height: 54px;
      background: #9413E6;
      padding: 4px;
      border-radius: 4px;
      width: 100%;
      overflow-x: hidden;
      display: flex;
      align-items: center;
      touch-action: none;
    }
    .timeline-utils{
      cursor: pointer;
    }
    .preview-timeline-grid {
      display: grid;
      grid-template-columns: repeat(15, 1fr);
      height: 100%;
      width: 100%;
    }
    .preview-timeline-grid img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-timeline-grid-placeholder {
      background: gray;
      width: 100%;
      height: 100%;
    }

    .timeline-ruler {
      position: relative;
      height: 20px;
      width: 100%;
      min-width: 100%;
    }

    .ruler-line {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 1px;
      background: #9CA3AF;
    }

    /* Time marker container */
    .time-marker {
      position: absolute;
      top: 0;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .marker-line {
      width: 1px;
      height: 5px;
      background: #9CA3AF;
    }

    /* Time label */
    .time-label {
      margin-top: 1px;
      font-size: 5.08px;
      color: #9CA3AF;
      white-space: nowrap;
    }

    /* Major markers (every 5 seconds) */
    .time-marker.major .marker-line {
      height: 10px;
      background: #9CA3AF;
    }
  
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .time-marker:nth-child(2n+1) .time-label {
        display: none;
      }
      
      .marker-line {
        height: 4px;
      }
      
      .time-marker.major .marker-line {
        height: 9px;
      }
    }
    .preview-timeline-drag {
      position: absolute;
      width: 5.08px;
      height: auto;
      cursor: ew-resize;
      z-index: 10;
      top: 30px;
    }
    .bar-wrapper{
      width: 100%;
      position: relative;
      min-height: 20px;
    }
    .music-bar, .broll-bar { position: absolute; display: flex; align-items: center; min-width: 150px; }
    .bar-wrapper div img{
       cursor: ew-resize;
    }
    .bar-body { 
      flex-grow: 1;
       background: #352B3D;
       min-width: 130px;
        display: flex;
         align-items: center; 
         justify-content: center;
         cursor: pointer;
         height: 20px;
         border: 1.52px solid #31164D;
         overflow: hidden;
         font-weight: 600px;
      font-size: 8.12px;
        }
    .broll-bar.selected .bar-body{  border: 2px solid #9413E6;}
    .preview-generate {
      background: #9413E6;
      color: white;
      font-size: 16px;
      font-weight: 500;
      margin-top: 8px;
      border-radius: 4px;
      width: 100%;
      max-width: 295px;
      height: 49px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .broll-overlay {
  position: absolute;
  width: 100%;
  height: 100%;
  z-index: 10; 
  object-position: center;
  object-fit: contain;
}
    .preview-generate:hover {
      opacity: 0.75;
    }
    .preview-canvas {
      display: none;
    }
    .hidden {
      display: none;
    }

    /* Payment Alert */
    .payment-alert {
      display: none;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4.1px);
      width: 100%;
      height: 100%;
      position: fixed;
      top: 95px;
      left: 0;
      z-index: 111111;
      justify-content: center;
      align-items: center;
    }
    @media (max-width: 640px) {
      .payment-alert {
        top: 80px;
      }
    }
    .payment-alert.show {
      display: flex;
    }
    .payment-alert-content {
      width: 100%;
      max-width: 485px;
      padding: 31px 22px;
      border: 1px solid #421F7B;
      background: #140926;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      gap: 80px;
    }
    .payment-alert-title {
      font-size: 20px;
      text-align: center;
    }
    .payment-alert-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .payment-alert-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .payment-alert-row-label {
      font-size: 20px;
      font-weight: 500;
    }
    .payment-alert-row-sublabel {
      font-size: 12px;
      font-weight: 500;
      color: #8C8C8C;
    }
    .payment-alert-row-value {
      font-size: 16px;
      font-weight: 400;
      color: #8C8C8C;
    }
    .payment-alert-divider {
      border-top: 1px solid rgba(140, 140, 140, 0.5);
    }
    .payment-alert-generate {
      background: #9413E6;
      color: white;
      font-size: 16px;
      font-weight: 500;
      border-radius: 4px;
      width: 100%;
      max-width: 295px;
      height: 49px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      align-self: center;
    }
    .payment-alert-generate:hover {
      opacity: 0.75;
    }

    /* Generating Overlay */
    .generating-overlay {
      display: none;
      background: #261148;
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      z-index: 20;
    }
    .generating-overlay.show {
      display: block;
    }
    .generating-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      gap: 20px;
      padding: 20px;
    }
    .generating-loader {
      width: 175.3px;
      height: 140px;
      margin-top: 199px;
      animation: pulse 1s infinite;
    }
    @media (max-width: 640px) {
      .generating-loader {
        margin-top: 160px;
      }
    }
    .generating-title {
      font-size: 32px;
      font-weight: 500;
      text-align: center;
    }
    .generating-progress {
      max-width: 715px;
      width: 100%;
      height: 5px;
      background: #D9D9D9;
      border-radius: 193px;
      overflow: hidden;
    }
    .generating-progress-bar {
      height: 100%;
      background: #9413E6;
      transition: width 0.1s;
    }
    .generating-message {
      font-size: 14px;
      color: rgba(140, 140, 140, 0.5);
      text-align: center;
    }

    /* Trouble Overlay */
    .trouble-overlay {
      display: none;
      background: #261148;
      width: 100%;
      height: 100%;
      position: fixed;
      top: 0;
      z-index: 20;
    }
    .trouble-overlay.show {
      display: block;
    }
    .trouble-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      gap: 20px;
      padding: 20px;
    }
    .trouble-loader {
      width: 175.3px;
      height: 140px;
      margin-top: 199px;
      animation: pulse 1s infinite;
    }
    @media (max-width: 640px) {
      .trouble-loader {
        margin-top: 160px;
      }
    }
    .trouble-heading {
      font-size: 32px;
      font-weight: 500;
      text-align: center;
    }
    .trouble-message {
      font-size: 14px;
      color: rgba(140, 140, 140, 0.5);
      text-align: center;
    }
    .trouble-buttons {
      width: 100%;
      max-width: 516px;
      height: 49px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .trouble-button-cancel {
      background: #140926;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8C8C8C;
      cursor: pointer;
      z-index: 2;
    }
    .trouble-button-retry {
      background: #9413E6;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
    }
    .subtitle-overlay{
      z-index: 100;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
      <img class="sidebar-logo" src="../assets/images/logo.png" alt="logo">
      <div class="sidebar-content">
        <div class="sidebar-panel">
          <!-- Avatar -->
          <div id="select-avatar" class="sidebar-select">
            <div class="sidebar-select-label">Avatar</div>
            <div id="select-avatar-button" class="sidebar-select-button">
              <img src="../assets/images/user-circle.png" alt="avatar">
              <span id="select-avatar-text">John Doe</span>
            </div>
            <div id="select-avatar-dropdown" class="sidebar-select-dropdown top">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('avatar')">
                <span>All Avatar</span>
              </div>
              <div class="sidebar-select-dropdown-search">
                <img src="../assets/images/search.png" alt="search">
                <input id="select-avatar-search" type="text" placeholder="Search">
              </div>
              <div class="avatar-toggle-switch">
                <button class="toggle-option toggle-option-active">My Avatar</button>
                <button class="toggle-option">Public Avatar</button>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-avatar-options" id="select-avatar-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
            
          </div>
          <!-- Camera -->
          <div id="select-camera" class="sidebar-select">
            <div class="sidebar-select-label">Camera</div>
            <div id="select-camera-button" class="sidebar-select-button">
              <img src="../assets/images/face-id.png" alt="camera">
              <span id="select-camera-text">Face</span>
            </div>
            <div id="select-camera-dropdown" class="sidebar-select-dropdown top">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('camera')">
                <span>Camera</span>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-camera-options" id="select-camera-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
          <!-- Zoom -->
          <div id="toggle-zoom" class="sidebar-toggle">
            <span>Zoom</span>
            <div id="toggle-zoom-switch" class="sidebar-toggle-switch off">
              <span class="sidebar-toggle-switch-circle off"></span>
            </div>
          </div>
          <!-- Body Language -->
          <div id="select-body-language" class="sidebar-select">
            <div class="sidebar-select-label">Body Language</div>
            <div id="select-body-language-button" class="sidebar-select-button">
              <img src="../assets/images/video-camera-ai.png" alt="body-language">
              <span id="select-body-language-text">Gesture 1</span>
            </div>
            <div id="select-body-language-dropdown" class="sidebar-select-dropdown top">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('body-language')">
                <span>Camera</span>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-camera-options" id="select-body-language-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
          <!-- Caption -->
          <div id="toggle-caption" class="sidebar-toggle">
            <span>Caption</span>
            <div id="toggle-caption-switch" class="sidebar-toggle-switch off">
              <span class="sidebar-toggle-switch-circle off"></span>
            </div>
          </div>
          <!-- AI Caption -->
          <div id="select-ai-caption" class="sidebar-select">
            <div class="sidebar-select-label">Ai Caption</div>
            <div id="select-ai-caption-button" class="sidebar-select-button dynamic">
              <img src="../assets/images/closed-caption.png" alt="ai-caption">
              <span id="select-ai-caption-text">DYNAMIC</span>
            </div>
            <div id="select-ai-caption-dropdown" class="sidebar-select-dropdown top">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('ai-caption')">
                <span>Caption</span>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-caption-options" id="select-ai-caption-options">
                  <!-- Populated by JS -->
                </div>
                <div class="sidebar-select-dropdown-caption-options-position">
                  <span>Position</span>
                  <div class="sidebar-select-dropdown-caption-options-position-buttons">
                    <button class="sidebar-select-dropdown-caption-options-position-button" onclick="selectCaptionPosition('Bottom')">Bottom</button>
                    <button class="sidebar-select-dropdown-caption-options-position-button" onclick="selectCaptionPosition('Middle')">Middle</button>
                    <button class="sidebar-select-dropdown-caption-options-position-button" onclick="selectCaptionPosition('Top')">Top</button>
                  </div>
                </div>
                <div class="sidebar-select-dropdown-caption-options-size">
                  <span>Size</span>
                  <div class="sidebar-select-dropdown-caption-options-size-buttons">
                    <button class="sidebar-select-dropdown-caption-options-size-button" onclick="selectCaptionSize('Large')">Large</button>
                    <button class="sidebar-select-dropdown-caption-options-size-button" onclick="selectCaptionSize('Medium')">Medium</button>
                    <button class="sidebar-select-dropdown-caption-options-size-button" onclick="selectCaptionSize('Small')">Small</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Background -->
          <div id="select-background" class="sidebar-select">
            <div class="sidebar-select-label">Background</div>
            <div id="select-background-button" class="sidebar-select-button">
              <span id="select-background-text">None</span>
            </div>
            <div id="select-background-dropdown" class="sidebar-select-dropdown bottom">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('background')">
                <span>Background</span>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-background-options" id="select-background-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
          <!-- Music -->
          <div id="select-music" class="sidebar-select">
            <div class="sidebar-select-label">Music</div>
            <div id="select-music-button" class="sidebar-select-button">
              <img src="../assets/images/music-note-square.png" alt="music">
              <span id="select-music-text">Cyberpunk Electro</span>
            </div>
            <div id="select-music-dropdown" class="sidebar-select-dropdown bottom">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('music')">
                <span>Music</span>
              </div>
              <div class="sidebar-select-dropdown-music-progress">
                <div id="music-progress-bar" class="sidebar-select-dropdown-music-progress-bar" style="width: 60%;">
                  <div id="music-progress-thumb" class="sidebar-select-dropdown-music-progress-thumb" style="left: calc(60% - 6px);"></div>
                </div>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-music-options" id="select-music-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
          <!-- Voice -->
          <div id="select-voice" class="sidebar-select">
            <div class="sidebar-select-label">Voice</div>
            <div id="select-voice-button" class="sidebar-select-button">
              <img src="../assets/images/voice.png" alt="voice">
              <span id="select-voice-text">John Doe</span>
            </div>
            <div id="select-voice-dropdown" class="sidebar-select-dropdown bottom">
              <div class="sidebar-select-dropdown-header">
                <img src="../assets/images/arrow-right.png" alt="back" onclick="closeDropdown('voice')">
                <span>Voice</span>
              </div>
              <div class="sidebar-select-dropdown-search">
                <img src="../assets/images/search.png" alt="search">
                <input id="select-voice-search" type="text" placeholder="Search">
              </div>
              <div class="sidebar-select-dropdown-voice-buttons">
                <div id="voice-language-button" class="sidebar-select-dropdown-voice-button">
                  <span id="voice-language-text">Language</span>
                  <img src="../assets/images/arrow-left.png" alt="arrow">
                  <div id="voice-language-list" class="sidebar-select-dropdown-voice-button-list left">
                    <div class="sidebar-select-dropdown-search">
                      <img src="../assets/images/search.png" alt="search">
                      <input id="voice-language-search" type="text" placeholder="Search">
                    </div>
                    <div id="voice-language-options" class="d-flex flex-column gap-1 w-100">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                </div>
                <div id="voice-gender-button" class="sidebar-select-dropdown-voice-button">
                  <span id="voice-gender-text">Gender</span>
                  <img src="../assets/images/arrow-left.png" alt="arrow">
                  <div id="voice-gender-list" class="sidebar-select-dropdown-voice-button-list right">
                    <div id="voice-gender-options" class="d-flex flex-column gap-1 w-100">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="sidebar-select-dropdown-options">
                <div class="sidebar-select-dropdown-options" id="select-voice-options">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
          <div id="sidebar-blur" class="sidebar-blur"></div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
      <img class="bg-top" src="../assets/images/bgtop.png" alt="bg svg">
      <img class="bg-bottom" src="../assets/images/bgbottom.png" alt="bg svg two">

      <!-- Navbar -->
      <div class="navbar">
        <div class="navbar-title">
          <img id="navbar-toggle" src="../assets/images/arrow-down-purple.png" alt="toggle">
          <span>Whats Todays Weather</span>
        </div>
        <div class="navbar-actions">
          <div class="navbar-actions-preview">Preview</div>
          <img src="../assets/images/circle-vertical-dots.png" alt="dots" style="cursor: pointer;">
        </div>
      </div>

      <!-- Preview Main -->
      <div class="preview-main">
        <textarea class="preview-textarea" placeholder="What's today's weather and how is it going"></textarea>
        <div id="preview-video-container" class="preview-video-container landscape">
          <video id="preview-video" alt="video of a person"></video>
        </div>
        <div class="preview-controls">
          <div class="preview-controls-left">
            <div id="orientation-toggle" class="preview-controls-left-orientation">
              <span id="orientation-text">Landscape</span>
              <img src="../assets/images/arrow-down-purple.png" alt="arrow">
            </div>
            <label for="add-image" class="preview-controls-left-add-image">
              <img src="../assets/images/image-add.png" alt="add image">
            </label>
            <input type="file" accept="image/*" class="hidden" id="add-image">
          </div>
          <div class="preview-controls-center">
            <img id="control-backward" src="../assets/images/go-backward-10-sec.png" alt="back 10s">
            <img id="control-previous" src="../assets/images/arrow-left-double.png" alt="prev">
            <img id="control-play-pause" src="../assets/images/play1.png" alt="play/pause">
            <img id="control-next" src="../assets/images/arrow-right-double.png" alt="next">
            <img id="control-forward" src="../assets/images/go-forward-10-sec.png" alt="forward 10s">
          </div>
          <div class="preview-controls-right">
            <span id="current-time">00:00.00</span>/<span id="duration">00:00.00</span>
          </div>
        </div>
        <div class="preview-timeline">
          <img id="timeline-drag" src="../assets/images/timelinedrag.png" alt="timelinedrag" class="preview-timeline-drag">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-content-center gap-2">
              <img class="timeline-utils" id="undo" src="../assets/images/undo.png" alt="undo">
              <img class="timeline-utils" id="redo" src="../assets/images/redo.png" alt="redo">
              <img class="timeline-utils" id="trash" style="cursor: pointer;" src="../assets/images/trash.png" alt="trash">
            </div>
            <div class="d-flex align-content-center gap-2">
              <img class="timeline-utils" id="zoomout" src="../assets/images/zoomout.png" alt="zoomout">
              <img class="timeline-utils" id="zoomin" style="cursor: pointer;" src="../assets/images/zoomin.png" alt="zoomin">
              <img class="timeline-utils" id="expand" style="cursor: pointer;" src="../assets/images/expand.png" alt="expand">
            </div>
          </div>
          <div class="timeline-ruler">
            <!-- The thin ruler line -->
            <div class="ruler-line"></div>
            
            <!-- Time markers (using percentage for responsiveness) -->
            <div class="time-marker major" style="left: 0%;">
              <div class="marker-line"></div>
              <div class="time-label">00:00</div>
            </div>
            
            <div class="time-marker" style="left: 5%;">
              <div class="marker-line"></div>
              <div class="time-label">00:01</div>
            </div>
            
            <div class="time-marker" style="left: 10%;">
              <div class="marker-line"></div>
              <div class="time-label">00:02</div>
            </div>
            
            <div class="time-marker" style="left: 15%;">
              <div class="marker-line"></div>
              <div class="time-label">00:03</div>
            </div>
            
            <div class="time-marker" style="left: 20%;">
              <div class="marker-line"></div>
              <div class="time-label">00:04</div>
            </div>
            
            <div class="time-marker major" style="left: 25%;">
              <div class="marker-line"></div>
              <div class="time-label">00:05</div>
            </div>
            
            <!-- Continue pattern up to 100% -->
            <div class="time-marker major" style="left: 50%;">
              <div class="marker-line"></div>
              <div class="time-label">00:10</div>
            </div>
            
            <div class="time-marker major" style="left: 100%;">
              <div class="marker-line"></div>
              <div class="time-label">00:20</div>
            </div>
          </div>
          <div id="timeline-canvas" class="w-100 d-flex flex-column gap-1 align-items-start">
            <div class="bar-wrapper" id="music-wrapper">

          </div>
          <div class="bar-wrapper" id="broll-wrapper">
           
          </div>
          <div id="timeline" class="preview-timeline-container">
            <div class="preview-timeline-grid" id="timeline-grid">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
        </div>
        <button id="generate-button" class="preview-generate">Generate</button>
        <canvas id="thumbnail-canvas" class="preview-canvas"></canvas>
      </div>

      <!-- Payment Alert -->
      <div id="payment-alert" class="payment-alert">
        <div class="payment-alert-content" onclick="event.stopPropagation()">
          <div class="payment-alert-title">Generate Video</div>
          <div class="payment-alert-details">
            <div class="payment-alert-row">
              <div class="payment-alert-row-label">Generate Video</div>
              <div class="payment-alert-row-value">$3.00</div>
            </div>
            <div class="payment-alert-row">
              <div>
                <div class="payment-alert-row-label">Pricing</div>
                <div class="payment-alert-row-sublabel">1 credit / minute</div>
              </div>
              <div class="payment-alert-row-value">$3.00</div>
            </div>
            <div class="payment-alert-divider"></div>
            <div class="payment-alert-row">
              <div class="payment-alert-row-label">New Balance</div>
              <div class="payment-alert-row-value">$2.70</div>
            </div>
          </div>
          <button id="payment-generate" class="payment-alert-generate">Generate</button>
        </div>
      </div>

      <!-- Generating Overlay -->
      <div id="generating-overlay" class="generating-overlay">
        <div class="generating-content">
          <img class="bg-top" src="../assets/images/bgtop.png" alt="bg svg">
          <img class="bg-bottom" src="../assets/images/bgbottom.png" alt="bg svg two">
          <img class="generating-loader" src="../assets/images/loader.png" alt="loader">
          <div class="generating-title">Performing Video Dual Magic</div>
          <div class="generating-progress">
            <div id="generating-progress-bar" class="generating-progress-bar" style="width: 0%;"></div>
          </div>
          <div class="generating-message">This May take few minutes</div>
        </div>
      </div>

      <!-- Trouble Overlay -->
      <div id="trouble-overlay" class="trouble-overlay">
        <div class="trouble-content">
          <img class="bg-top" src="../assets/images/bgtop.png" alt="bg svg">
          <img class="bg-bottom" src="../assets/images/bgbottom.png" alt="bg svg two">
          <img class="trouble-loader" src="../assets/images/loader.png" alt="loader">
          <div class="trouble-heading">We’re having trouble generating your video</div>
          <div class="trouble-message">A bug report has been submitted to our tech team, they’re looking into it - in the meantime, you can retry or create another project.</div>
          <div class="trouble-buttons">
            <button id="trouble-cancel" class="trouble-button-cancel">Cancel</button>
            <button id="trouble-retry" class="trouble-button-retry">Retry</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
 // State
let showSlide = window.innerWidth > 1024;
let blurbg = false;
let selectName = '';
let allowZoom = false;
let allowCaption = false;
let selectedOptions = {
  Avatar: 'John Doe',
  Camera: 'Face',
  'Body Language': 'Gesture 1',
  'Ai Caption': 'DYNAMIC',
  Background: 'None',
  Music: 'None',
  Voice: 'None'
};
let isLandScape = true;
let splitPosition = 50;
let isDragging = false;
let showPaymentAlert = false;
let generating = false;
let error = false;
let isplay = false;
let avatar = {};
let currentTime = 0;
let duration = 0;
let thumbnails = [];
let captionPosition = 'Bottom';
let captionSize = 'Medium';
let voiceLanguage = 'Language';
let voiceGender = 'Gender';
let backgroundMusic = null;
let musicVolume = 0.6;
let isMyAvatarActive = true;

// Timeline-specific state
let zoomLevel = 1;
let maxZoom = 3;
let minZoom = 0.5;
let isTimelineExpanded = false;
let musicBar = { start: 0, end: 0, src: null, musicDuration: 0 };
let brollBars = [];
let history = [];
let historyIndex = -1;
let selectedBroll = null;
let isDraggingBar = false;
let isTrimming = false;
let trimSide = null;
let draggedBar = null;

// Options
const avatarOptions = ['John Doe', 'Simon Phil', 'Ruda Mark', 'Jane Path'];
const publicAvatarOptions = ['Public User 1', 'Public User 2', 'Public User 3', 'Public User 4'];
const cameraOptions = ['Face', 'Side Profile'];
const bodyLanguageOptions = ['Gesture 1', 'Gesture 2'];
const aiCaptionOptions = ['DYNAMIC', 'PROFESSIONAL', 'DOCUMENTARY'];
const backgroundOptions = ['None', 'Upload', 'Mist', 'Mist', 'Mist', 'Mist'];
const musicOptions = ['None', 'Cyberpunk Electro', 'Dramatic Tension', 'Future Bass', 'R&B Smooth', 'Trap HipHop', 'Epic Orchestral', 'Acoustic Folks', 'Funky Groove'];
const voiceOptions = ['None', 'Cabby Doctor', 'Emma Earrings', 'Louis', 'Lao'];
const languageOptions = ['Language', 'English', 'French', 'Spanish'];
const genderOptions = ['Gender', 'Male', 'Female'];
let filteredAvatarOptions = avatarOptions;
let filteredPublicAvatarOptions = publicAvatarOptions;
let filteredVoiceOptions = voiceOptions;
let filteredLanguageOptions = languageOptions;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initializeSidebar();
  initializeNavbar();
  initializePreviewMain();
  initializeLocalStorage();
  updateSidebarVisibility();
  generateThumbnails();
  setupVideoMusicSync();
  applyVideoEffects();
});

// Apply video effects
function applyVideoEffects() {
  const video = document.getElementById('preview-video');
  const videoContainer = document.getElementById('preview-video-container');
  
  video.style.filter = '';
  video.style.transform = '';
  videoContainer.style.background = 'black';
  
  videoContainer.classList.toggle('landscape', isLandScape);
  videoContainer.classList.toggle('portrait', !isLandScape);
  
  if (allowZoom) {
    video.style.objectFit = 'cover';
  } else {
    video.style.objectFit = 'contain';
  }

  if (allowCaption) {
    videoContainer.style.position = 'relative';
    let subtitleDiv = videoContainer.querySelector('.subtitle-overlay');
    if (!subtitleDiv) {
      subtitleDiv = document.createElement('div');
      subtitleDiv.className = 'subtitle-overlay';
      subtitleDiv.style.position = 'absolute';
      subtitleDiv.style.width = '100%';
      subtitleDiv.style.textAlign = 'center';
      subtitleDiv.style.textShadow = '0 0 5px black';
      videoContainer.appendChild(subtitleDiv);
    }
    switch (captionPosition) {
      case 'Top':
        subtitleDiv.style.top = '10%';
        subtitleDiv.style.bottom = 'auto';
        break;
      case 'Middle':
        subtitleDiv.style.top = '50%';
        subtitleDiv.style.transform = 'translateY(-50%)';
        subtitleDiv.style.bottom = 'auto';
        break;
      case 'Bottom':
        subtitleDiv.style.bottom = '10%';
        subtitleDiv.style.top = 'auto';
        break;
    }
    switch (captionSize) {
      case 'Large':
        subtitleDiv.style.fontSize = '24px';
        break;
      case 'Medium':
        subtitleDiv.style.fontSize = '16px';
        break;
      case 'Small':
        subtitleDiv.style.fontSize = '12px';
        break;
    }
    subtitleDiv.classList.remove('dynamic', 'professional', 'documentary');
    subtitleDiv.classList.add(selectedOptions['Ai Caption'].toLowerCase());
    subtitleDiv.textContent = `Sample ${selectedOptions['Ai Caption']} Caption`;
  } else {
    const subtitleDiv = videoContainer.querySelector('.subtitle-overlay');
    if (subtitleDiv) subtitleDiv.remove();
  }

  if (selectedOptions.Background !== 'None' && selectedOptions.Background !== 'Upload') {
    videoContainer.style.background = `url('../assets/images/${selectedOptions.Background.toLowerCase()}.png') no-repeat center/cover`;
  }

  if (selectedOptions.Music !== 'None') {
    videoContainer.style.border = '2px solid #9413E6';
  } else {
    videoContainer.style.border = '';
  }

  if (selectedOptions.Voice !== 'None') {
    videoContainer.style.boxShadow = '0 0 10px rgba(148, 19, 230, 0.5)';
  } else {
    videoContainer.style.boxShadow = '';
  }

  // Handle b-roll image display
  let brollDisplayed = false;
  const brollOverlay = videoContainer.querySelector('.broll-overlay');
  if (brollOverlay) brollOverlay.remove();

  brollBars.forEach(broll => {
    if (currentTime >= broll.start && currentTime <= broll.end) {
      brollDisplayed = true;
      const overlay = document.createElement('img');
      overlay.className = 'broll-overlay';
      overlay.src = broll.url;
      overlay.style.position = 'absolute';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.objectFit = allowZoom ? 'cover' : 'contain';
      videoContainer.appendChild(overlay);
    }
  });

  if (!brollDisplayed) {
    const existingOverlay = videoContainer.querySelector('.broll-overlay');
    if (existingOverlay) existingOverlay.remove();
  }
}

// Video and music sync
function setupVideoMusicSync() {
  const video = document.getElementById('preview-video');
  video.addEventListener('play', () => {
    if (selectedOptions.Music !== 'None' && backgroundMusic && currentTime >= musicBar.start && currentTime <= musicBar.end) {
      backgroundMusic.currentTime = (currentTime - musicBar.start) % musicBar.musicDuration;
      backgroundMusic.play();
    }
  });
  video.addEventListener('pause', () => {
    if (backgroundMusic) {
      backgroundMusic.pause();
    }
  });
  video.addEventListener('ended', () => {
    if (backgroundMusic) {
      backgroundMusic.pause();
      backgroundMusic.currentTime = 0;
    }
  });
  video.addEventListener('seeked', () => {
    if (backgroundMusic) {
      if (currentTime >= musicBar.start && currentTime <= musicBar.end) {
        backgroundMusic.currentTime = (currentTime - musicBar.start) % musicBar.musicDuration;
        if (isplay) backgroundMusic.play();
      } else {
        backgroundMusic.pause();
      }
    }
    applyVideoEffects(); // Update b-roll display on seek
  });
  video.addEventListener('timeupdate', () => {
    if (backgroundMusic && isplay) {
      if (currentTime < musicBar.start || currentTime > musicBar.end) {
        backgroundMusic.pause();
      } else if (currentTime >= musicBar.start && currentTime <= musicBar.end && backgroundMusic.paused) {
        backgroundMusic.currentTime = (currentTime - musicBar.start) % musicBar.musicDuration;
        backgroundMusic.play();
      }
    }
    applyVideoEffects(); // Update b-roll display on timeupdate
  });
}

// Sidebar
function initializeSidebar() {
  const sidebar = document.getElementById('sidebar');
  const blur = document.getElementById('sidebar-blur');

  updateAvatarOptions();
  document.getElementById('select-avatar-button').addEventListener('click', () => toggleDropdown('avatar'));
  document.getElementById('select-avatar-search').addEventListener('input', (e) => {
    const value = e.target.value.toLowerCase();
    if (isMyAvatarActive) {
      filteredAvatarOptions = avatarOptions.filter(option => option.toLowerCase().includes(value));
    } else {
      filteredPublicAvatarOptions = publicAvatarOptions.filter(option => option.toLowerCase().includes(value));
    }
    updateAvatarOptions();
  });
  
  document.getElementById('select-avatar-search').addEventListener('click', (e) => {
    e.stopPropagation();
  });
  
  const myAvatarBtn = document.querySelector('.avatar-toggle-switch .toggle-option:nth-child(1)');
  const publicAvatarBtn = document.querySelector('.avatar-toggle-switch .toggle-option:nth-child(2)');
  myAvatarBtn.addEventListener('click', () => {
    if (!isMyAvatarActive) {
      isMyAvatarActive = true;
      myAvatarBtn.classList.add('toggle-option-active');
      publicAvatarBtn.classList.remove('toggle-option-active');
      filteredAvatarOptions = avatarOptions;
      updateAvatarOptions();
    }
  });
  publicAvatarBtn.addEventListener('click', () => {
    if (isMyAvatarActive) {
      isMyAvatarActive = false;
      publicAvatarBtn.classList.add('toggle-option-active');
      myAvatarBtn.classList.remove('toggle-option-active');
      filteredPublicAvatarOptions = publicAvatarOptions;
      updateAvatarOptions();
    }
  });

  updateCameraOptions();
  document.getElementById('select-camera-button').addEventListener('click', () => toggleDropdown('camera'));

  document.getElementById('toggle-zoom-switch').addEventListener('click', () => {
    allowZoom = !allowZoom;
    updateToggle('zoom', allowZoom);
    applyVideoEffects();
  });

  updateBodyLanguageOptions();
  document.getElementById('select-body-language-button').addEventListener('click', () => toggleDropdown('body-language'));

  document.getElementById('toggle-caption-switch').addEventListener('click', () => {
    allowCaption = !allowCaption;
    updateToggle('caption', allowCaption);
    applyVideoEffects();
  });

  updateAiCaptionOptions();
  document.getElementById('select-ai-caption-button').addEventListener('click', () => toggleDropdown('ai-caption'));

  updateBackgroundOptions();
  document.getElementById('select-background-button').addEventListener('click', () => toggleDropdown('background'));

  updateMusicOptions();
  document.getElementById('select-music-button').addEventListener('click', () => toggleDropdown('music'));
  initializeMusicProgressBar();

  updateVoiceOptions();
  updateLanguageOptions();
  updateGenderOptions();
  document.getElementById('select-voice-button').addEventListener('click', () => toggleDropdown('voice'));
  document.getElementById('select-voice-search').addEventListener('input', (e) => {
    filteredVoiceOptions = voiceOptions.filter(option => option.toLowerCase().includes(e.target.value.toLowerCase()));
    updateVoiceOptions();
  });
  document.getElementById('select-voice-search').addEventListener('click', (e) => {
    e.stopPropagation();
  });
  document.getElementById('voice-language-button').addEventListener('click', () => {
    document.getElementById('voice-language-list').classList.toggle('show');
  });
  document.getElementById('voice-gender-button').addEventListener('click', () => {
    document.getElementById('voice-gender-list').classList.toggle('show');
  });
  document.getElementById('voice-language-search').addEventListener('input', (e) => {
    filteredLanguageOptions = languageOptions.filter(option => option.toLowerCase().includes(e.target.value.toLowerCase()));
    updateLanguageOptions();
  });
  
  document.getElementById('voice-language-search').addEventListener('click', (e) => {
    e.stopPropagation();
  });

  document.addEventListener('mousedown', (event) => {
    const dropdowns = [
      'avatar', 'camera', 'body-language', 'ai-caption', 'background', 'music', 'voice'
    ];
    dropdowns.forEach(name => {
      const button = document.getElementById(`select-${name}-button`);
      const dropdown = document.getElementById(`select-${name}-dropdown`);
      if (!button.contains(event.target) && !dropdown.contains(event.target)) {
        closeDropdown(name);
      }
    });
    const voiceLists = ['language', 'gender'];
    voiceLists.forEach(type => {
      const button = document.getElementById(`voice-${type}-button`);
      const list = document.getElementById(`voice-${type}-list`);
      if (!button.contains(event.target) && !list.contains(event.target)) {
        list.classList.remove('show');
      }
    });
    if (!sidebar.contains(event.target) && !document.getElementById('navbar-toggle').contains(event.target)) {
      blurbg = false;
      blur.classList.remove('show');
    }
  });
}

// Initialize music progress bar
function initializeMusicProgressBar() {
  const progressBarContainer = document.querySelector('.sidebar-select-dropdown-music-progress');
  const progressBar = document.getElementById('music-progress-bar');
  const thumb = document.getElementById('music-progress-thumb');
  let isDragging = false;

  function updateProgressBar() {
    const percent = musicVolume * 100;
    progressBar.style.width = `${percent}%`;
    thumb.style.left = `calc(${percent}% - 6px)`;
  }

  function setVolumeFromPosition(clientX) {
    const rect = progressBarContainer.getBoundingClientRect();
    let x = clientX - rect.left;
    x = Math.max(0, Math.min(x, rect.width));
    musicVolume = x / rect.width;

    if (backgroundMusic) {
      backgroundMusic.volume = musicVolume;
    }

    updateProgressBar();
  }

  function onMouseMove(e) {
    if (isDragging) {
      setVolumeFromPosition(e.clientX);
    }
  }

  function onTouchMove(e) {
    if (isDragging) {
      e.preventDefault();
      setVolumeFromPosition(e.touches[0].clientX);
    }
  }

  function stopDragging() {
    isDragging = false;
    window.removeEventListener('mousemove', onMouseMove);
    window.removeEventListener('touchmove', onTouchMove);
    window.removeEventListener('mouseup', stopDragging);
    window.removeEventListener('touchend', stopDragging);
  }

  function startDragging(e) {
    isDragging = true;
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    setVolumeFromPosition(clientX);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('touchmove', onTouchMove, { passive: false });
    window.addEventListener('mouseup', stopDragging);
    window.addEventListener('touchend', stopDragging);
  }

  progressBarContainer.addEventListener('mousedown', startDragging);
  progressBarContainer.addEventListener('touchstart', startDragging, { passive: false });
  updateProgressBar();
}

function toggleDropdown(name) {
  const dropdown = document.getElementById(`select-${name}-dropdown`);
  const isOpen = dropdown.classList.contains('show');
  closeAllDropdowns();
  if (!isOpen) {
    dropdown.classList.add('show');
    selectName = name;
    blurbg = true;
    document.getElementById('sidebar-blur').classList.add('show');
  }
}

function closeDropdown(name) {
  const dropdown = document.getElementById(`select-${name}-dropdown`);
  dropdown.classList.remove('show');
  selectName = '';
  blurbg = document.querySelectorAll('.sidebar-select-dropdown.show').length > 0;
  document.getElementById('sidebar-blur').classList.toggle('show', blurbg);
}

function closeAllDropdowns() {
  const dropdowns = [
    'avatar', 'camera', 'body-language', 'ai-caption', 'background', 'music', 'voice'
  ];
  dropdowns.forEach(name => {
    document.getElementById(`select-${name}-dropdown`).classList.remove('show');
  });
  document.getElementById('voice-language-list').classList.remove('show');
  document.getElementById('voice-gender-list').classList.remove('show');
  selectName = '';
  blurbg = false;
  document.getElementById('sidebar-blur').classList.remove('show');
}

function updateAvatarOptions() {
  const container = document.getElementById('select-avatar-options');
  const options = isMyAvatarActive ? filteredAvatarOptions : filteredPublicAvatarOptions;
  container.innerHTML = options.map(option => `
    <div class="sidebar-select-dropdown-avatar-option" onclick="selectOption('Avatar', '${option}')">
      <img src="../assets/images/person-12.png" alt="avatar">
      <div class="sidebar-select-dropdown-avatar-option-text">${option}</div>
    </div>
  `).join('');
}

function updateCameraOptions() {
  const container = document.getElementById('select-camera-options');
  container.innerHTML = cameraOptions.map(option => `
    <div class="sidebar-select-dropdown-camera-option" onclick="selectOption('Camera', '${option}')">
      <img src="../assets/images/person-12.png" alt="camera">
      <div class="sidebar-select-dropdown-camera-option-text">${option}</div>
    </div>
  `).join('');
}

function updateBodyLanguageOptions() {
  const container = document.getElementById('select-body-language-options');
  container.innerHTML = bodyLanguageOptions.map(option => `
    <div class="sidebar-select-dropdown-camera-option" onclick="selectOption('Body Language', '${option}')">
      <img src="../assets/images/person-12.png" alt="body-language">
      <div class="sidebar-select-dropdown-camera-option-text">${option}</div>
    </div>
  `).join('');
}

function updateAiCaptionOptions() {
  const container = document.getElementById('select-ai-caption-options');
  container.innerHTML = aiCaptionOptions.map(option => `
    <div class="sidebar-select-dropdown-option ${option.toLowerCase()}" onclick="selectOption('Ai Caption', '${option}')">${option}</div>
  `).join('');
}

function updateBackgroundOptions() {
  const container = document.getElementById('select-background-options');
  container.innerHTML = backgroundOptions.map((option, i) => `
    <div class="sidebar-select-dropdown-background-option ${option === 'Upload' ? 'upload' : ''}" onclick="selectOption('Background', '${option}')">
      ${option === 'Upload' ? '<img src="../assets/images/upload.png" alt="upload">' : ''}
      <div>${option}</div>
    </div>
  `).join('');
}

function updateMusicOptions() {
  const container = document.getElementById('select-music-options');
  container.innerHTML = musicOptions.map(option => `
    <div class="sidebar-select-dropdown-option" onclick="selectOption('Music', '${option}')">
      <img src="../assets/images/play1.png" alt="play">
      ${option}
    </div>
  `).join('');
}

function updateVoiceOptions() {
  const container = document.getElementById('select-voice-options');
  container.innerHTML = filteredVoiceOptions.map(option => `
    <div class="sidebar-select-dropdown-option" onclick="selectOption('Voice', '${option}')">
      <img src="../assets/images/play1.png" alt="play">
      ${option}
    </div>
  `).join('');
}

function updateLanguageOptions() {
  const container = document.getElementById('voice-language-options');
  container.innerHTML = filteredLanguageOptions.map(option => `
    <div class="sidebar-select-dropdown-voice-button-option" onclick="selectVoiceFilter('language', '${option}')">${option}</div>
  `).join('');
}

function updateGenderOptions() {
  const container = document.getElementById('voice-gender-options');
  container.innerHTML = genderOptions.map(option => `
    <div class="sidebar-select-dropdown-voice-button-option" onclick="selectVoiceFilter('gender', '${option}')">${option}</div>
  `).join('');
}

function updateToggle(name, isOn) {
  const toggle = document.getElementById(`toggle-${name}-switch`);
  toggle.classList.toggle('on', isOn);
  toggle.classList.toggle('off', !isOn);
  toggle.children[0].classList.toggle('on', isOn);
  toggle.children[0].classList.toggle('off', !isOn);
}

function selectOption(name, option) {
  selectedOptions[name] = option;
  const button = document.getElementById(`select-${name.toLowerCase().replace(' ', '-')}-button`);
  const text = document.getElementById(`select-${name.toLowerCase().replace(' ', '-')}-text`);
  text.textContent = option;
  if (name === 'Ai Caption') {
    button.className = 'sidebar-select-button';
    if (option === 'DYNAMIC') button.classList.add('dynamic');
    if (option === 'PROFESSIONAL') button.classList.add('professional');
    if (option === 'DOCUMENTARY') button.classList.add('documentary');
  } else if (name === 'Music') {
    if (option !== 'None') {
      if (backgroundMusic) {
        backgroundMusic.pause();
        backgroundMusic = null;
      }
      backgroundMusic = new Audio('../assets/music/demo-music.mp3');
      backgroundMusic.loop = false;
      backgroundMusic.volume = musicVolume;
      backgroundMusic.onloadedmetadata = () => {
        const musicDuration = backgroundMusic.duration;
        musicBar = { 
          start: 0, 
          end: Math.min(musicDuration, duration || 20), 
          src: option, 
          musicDuration 
        };
        updateMusicBar();
        saveToHistory('music', { musicBar: { ...musicBar } });
      };
    } else {
      if (backgroundMusic) {
        backgroundMusic.pause();
        backgroundMusic = null;
      }
      musicBar = { start: 0, end: 0, src: null, musicDuration: 0 };
      updateMusicBar();
      saveToHistory('music', { musicBar: { ...musicBar } });
    }
  } else if (name === 'Voice' && option !== 'None') {
    const voiceAudio = new Audio('../assets/voices/demo-voice.mp3');
    voiceAudio.play().catch(err => console.error('Error playing voice audio:', err));
  }
  closeDropdown(name.toLowerCase().replace(' ', '-'));
  applyVideoEffects();
}

function selectCaptionPosition(position) {
  captionPosition = position;
  applyVideoEffects();
}

function selectCaptionSize(size) {
  captionSize = size;
  applyVideoEffects();
}

function selectVoiceFilter(type, value) {
  if (type === 'language') {
    voiceLanguage = value;
    document.getElementById('voice-language-text').textContent = value;
    document.getElementById('voice-language-list').classList.remove('show');
  } else {
    voiceGender = value;
    document.getElementById('voice-gender-text').textContent = value;
    document.getElementById('voice-gender-list').classList.remove('show');
  }
}

function updateSidebarVisibility() {
  const sidebar = document.getElementById('sidebar');
  sidebar.style.display = showSlide ? 'flex' : 'none';
}

// Navbar
function initializeNavbar() {
  const toggle = document.getElementById('navbar-toggle');
  toggle.addEventListener('click', () => {
    showSlide = !showSlide;
    updateSidebarVisibility();
    toggle.src = showSlide ? '../assets/images/arrow-down-purple.png' : '../assets/images/arrow-down-purple.png';
  });

  window.addEventListener('resize', () => {
    showSlide = window.innerWidth > 1024;
    updateSidebarVisibility();
    toggle.src = showSlide ? '../assets/images/arrow-down-purple.png' : '../assets/images/arrow-down-purple.png';
  });
}

// LocalStorage
function initializeLocalStorage() {
  const storedAvatars = localStorage.getItem('AVATARS');
  const storedVideoFormat = localStorage.getItem('VIDEO_FORMAT');
  const storedAutoBRoll = localStorage.getItem('AUTO_BROLL');
  const storedSource = localStorage.getItem('SOURCE');
  const storedStyle = localStorage.getItem('STYLE');
  const storedIntensity = localStorage.getItem('INTENSITY');
  const storedSubtitles = localStorage.getItem('SUBTITLES');
  const storedSubtitleVoice = localStorage.getItem('SUBTITLE_VOICE');
  const storedMusic = localStorage.getItem('SELECTED_MUSIC');
  const storedMusicSrc = localStorage.getItem('MUSIC_SRC');
  const storedVoice = localStorage.getItem('SELECTED_VOICE');
  const storedVoiceSrc = localStorage.getItem('VOICE_SRC');
  const storedLanguage = localStorage.getItem('SELECTED_LANGUAGE');
  const storedGender = localStorage.getItem('SELECTED_GENDER');

  if (storedAvatars) {
    try {
      const parsedAvatars = JSON.parse(storedAvatars);
      avatar = parsedAvatars[0] || {};
      if (avatar.video) {
        document.getElementById('preview-video').src = avatar.video;
      }
    } catch (err) {
      console.error('Error parsing avatars from localStorage:', err);
    }
  }

  if (storedVideoFormat) {
    isLandScape = storedVideoFormat === 'Landscape';
    document.getElementById('orientation-text').textContent = isLandScape ? 'Landscape' : 'Portrait';
  }

  if (storedSubtitles === 'true') {
    allowCaption = true;
    updateToggle('caption', true);
    if (storedSubtitleVoice && storedSubtitleVoice !== 'Disabled') {
      selectedOptions['Ai Caption'] = storedSubtitleVoice;
      const button = document.getElementById('select-ai-caption-button');
      const text = document.getElementById('select-ai-caption-text');
      text.textContent = storedSubtitleVoice;
      button.className = 'sidebar-select-button';
      if (storedSubtitleVoice === 'DYNAMIC') button.classList.add('dynamic');
      if (storedSubtitleVoice === 'PROFESSIONAL') button.classList.add('professional');
      if (storedSubtitleVoice === 'DOCUMENTARY') button.classList.add('documentary');
    }
  }

  if (storedMusic && storedMusic !== 'None' && storedMusicSrc) {
    selectedOptions.Music = storedMusic;
    document.getElementById('select-music-text').textContent = storedMusic;
    backgroundMusic = new Audio(storedMusicSrc);
    backgroundMusic.loop = false;
    backgroundMusic.volume = musicVolume;
    backgroundMusic.onloadedmetadata = () => {
      musicBar = { 
        start: 0, 
        end: Math.min(backgroundMusic.duration, duration || 20), 
        src: storedMusic, 
        musicDuration: backgroundMusic.duration 
      };
      updateMusicBar();
    };
  }

  if (storedVoice && storedVoice !== 'None') {
    selectedOptions.Voice = storedVoice;
    document.getElementById('select-voice-text').textContent = storedVoice;
  }

  if (storedLanguage && storedLanguage !== 'Language') {
    voiceLanguage = storedLanguage;
    document.getElementById('voice-language-text').textContent = storedLanguage;
  }

  if (storedGender && storedGender !== 'Gender') {
    voiceGender = storedGender;
    document.getElementById('voice-gender-text').textContent = storedGender;
  }
}

// Timeline Functions
function updateTimelineRuler() {
  const ruler = document.querySelector('.timeline-ruler');
  ruler.innerHTML = '<div class="ruler-line"></div>';
  const interval = (duration / (10 * zoomLevel)) || 1;
  const numMarkers = Math.ceil(duration / interval) + 1;
  for (let i = 0; i < numMarkers; i++) {
    const time = i * interval;
    if (time > duration) break;
    const isMajor = i % 5 === 0;
    const marker = document.createElement('div');
    marker.className = `time-marker ${isMajor ? 'major' : ''}`;
    marker.style.left = `${(time / duration) * 100}%`;
    marker.innerHTML = `
      <div class="marker-line"></div>
      <div class="time-label">${formatTime(time)}</div>
    `;
    ruler.appendChild(marker);
  }
}

function updateMusicBar() {
  const wrapper = document.getElementById('music-wrapper');
  wrapper.innerHTML = '';
  if (musicBar.src) {
    const bar = document.createElement('div');
    bar.className = 'music-bar';
    bar.innerHTML = `
      <img src="../assets/images/trimthumb.png" alt="trim thumb start" class="trim-thumb start">
      <div class="bar-body">${musicBar.src}.mp3</div>
      <img src="../assets/images/trimthumb.png" alt="trim thumb end" class="trim-thumb end">
    `;
    wrapper.appendChild(bar);
    const left = (musicBar.start / duration) * 100;
    const width = Math.max(150, ((musicBar.end - musicBar.start) / duration) * wrapper.offsetWidth);
    bar.style.left = `${left}%`;
    bar.style.width = `${width}px`;
    addBarEventListeners(bar, 'music');
  }
}

function updateBrollBars() {
  const wrapper = document.getElementById('broll-wrapper');
  wrapper.innerHTML = '';
  brollBars.forEach((broll, index) => {
    const bar = document.createElement('div');
    bar.className = 'broll-bar';
    bar.dataset.index = index;
    bar.innerHTML = `
      <img src="../assets/images/trimthumb.png" alt="trim thumb start" class="trim-thumb start">
      <div class="bar-body">${broll.name}</div>
      <img src="../assets/images/trimthumb.png" alt="trim thumb end" class="trim-thumb end">
    `;
    wrapper.appendChild(bar);
    const left = (broll.start / duration) * 100;
    const width = Math.max(150, ((broll.end - broll.start) / duration) * wrapper.offsetWidth);
    bar.style.left = `${left}%`;
    bar.style.width = `${width}px`;
    addBarEventListeners(bar, 'broll');
  });
}

function addBarEventListeners(bar, type) {
  const body = bar.querySelector('.bar-body');
  const startThumb = bar.querySelector('.trim-thumb.start');
  const endThumb = bar.querySelector('.trim-thumb.end');

  body.addEventListener('mousedown', (e) => handleBarDragStart(e, bar, type));
  body.addEventListener('touchstart', (e) => handleBarDragStart(e, bar, type), { passive: false });
  startThumb.addEventListener('mousedown', (e) => handleTrimStart(e, bar, type, 'start'));
  startThumb.addEventListener('touchstart', (e) => handleTrimStart(e, bar, type, 'start'), { passive: false });
  endThumb.addEventListener('mousedown', (e) => handleTrimStart(e, bar, type, 'end'));
  endThumb.addEventListener('touchstart', (e) => handleTrimStart(e, bar, type, 'end'), { passive: false });
  body.addEventListener('click', (e) => {
    if (type === 'broll' && !isDraggingBar && !isTrimming) {
      selectBroll(bar);
    }
  });
}

function selectBroll(bar) {
  const trash = document.getElementById('trash');
  selectedBroll = bar;
  document.querySelectorAll('.broll-bar').forEach(b => b.classList.remove('selected'));
  bar.classList.add('selected');
  trash.style.filter = 'brightness(1.5)';
}

function deselectBroll() {
  const trash = document.getElementById('trash');
  if (selectedBroll) {
    selectedBroll.classList.remove('selected');
    selectedBroll = null;
    trash.style.filter = '';
  }
}

function handleBarDragStart(e, bar, type) {
  e.preventDefault();
  isDraggingBar = true;
  draggedBar = { 
    bar, 
    type, 
    index: type === 'broll' ? parseInt(bar.dataset.index) : null,
    startX: e.type.includes('touch') ? e.touches[0].clientX : e.clientX,
    initialStart: type === 'music' ? musicBar.start : brollBars[parseInt(bar.dataset.index)].start
  };
  document.addEventListener('mousemove', handleBarDragMove);
  document.addEventListener('touchmove', handleBarDragMove, { passive: false });
  document.addEventListener('mouseup', handleBarDragEnd);
  document.addEventListener('touchend', handleBarDragEnd);
}

function handleBarDragMove(e) {
  if (isDraggingBar && draggedBar) {
    const wrapper = document.getElementById(draggedBar.type === 'music' ? 'music-wrapper' : 'broll-wrapper');
    const rect = wrapper.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const dx = clientX - draggedBar.startX;
    const wrapperWidth = rect.width;
    const timePerPixel = duration / wrapperWidth;
    let newStart = draggedBar.initialStart + (dx * timePerPixel);
    newStart = Math.max(0, Math.min(duration, newStart));

    if (draggedBar.type === 'music') {
      const barDuration = musicBar.end - musicBar.start;
      musicBar.start = newStart;
      musicBar.end = Math.min(duration, newStart + barDuration);
      updateMusicBar();
    } else {
      const broll = brollBars[draggedBar.index];
      const barDuration = broll.end - broll.start;
      broll.start = newStart;
      broll.end = Math.min(duration, newStart + barDuration);
      updateBrollBars();
    }
  }
}

function handleBarDragEnd() {
  if (isDraggingBar && draggedBar) {
    saveToHistory(draggedBar.type, {
      musicBar: { ...musicBar },
      brollBars: brollBars.map(b => ({ ...b }))
    });
    isDraggingBar = false;
    draggedBar = null;
    document.removeEventListener('mousemove', handleBarDragMove);
    document.removeEventListener('touchmove', handleBarDragMove);
    document.removeEventListener('mouseup', handleBarDragEnd);
    document.removeEventListener('touchend', handleBarDragEnd);
  }
}

function handleTrimStart(e, bar, type, side) {
  e.preventDefault();
  isTrimming = true;
  trimSide = side;
  draggedBar = { 
    bar, 
    type, 
    index: type === 'broll' ? parseInt(bar.dataset.index) : null,
    startX: e.type.includes('touch') ? e.touches[0].clientX : e.clientX,
    lastUpdate: Date.now()
  };
  document.addEventListener('mousemove', handleTrimMove);
  document.addEventListener('touchmove', handleTrimMove, { passive: false });
  document.addEventListener('mouseup', handleTrimEnd);
  document.addEventListener('touchend', handleTrimEnd);
}

function handleTrimMove(e) {
  if (isTrimming && draggedBar) {
    const now = Date.now();
    if (now - draggedBar.lastUpdate < 16) return; // Debounce to ~60fps
    draggedBar.lastUpdate = now;

    const wrapper = document.getElementById(draggedBar.type === 'music' ? 'music-wrapper' : 'broll-wrapper');
    const rect = wrapper.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const dx = (clientX - draggedBar.startX) * 0.08; // Damping factor for smoother resizing
    const wrapperWidth = rect.width;
    const timePerPixel = duration / wrapperWidth;
    const minDuration = (150 / wrapperWidth) * duration; // Min width of 150px converted to time

    if (draggedBar.type === 'music') {
      if (trimSide === 'start') {
        let newStart = musicBar.start + (dx * timePerPixel);
        newStart = Math.max(0, Math.min(musicBar.end - minDuration, newStart));
        musicBar.start = newStart;
      } else {
        let newEnd = musicBar.end + (dx * timePerPixel);
        newEnd = Math.min(duration, Math.max(musicBar.start + minDuration, newEnd));
        musicBar.end = newEnd;
      }
      updateMusicBar();
    } else {
      const broll = brollBars[draggedBar.index];
      if (trimSide === 'start') {
        let newStart = broll.start + (dx * timePerPixel);
        newStart = Math.max(0, Math.min(broll.end - minDuration, newStart));
        broll.start = newStart;
      } else {
        let newEnd = broll.end + (dx * timePerPixel);
        newEnd = Math.min(duration, Math.max(broll.start + minDuration, newEnd));
        broll.end = newEnd;
      }
      updateBrollBars();
    }
  }
}

function handleTrimEnd() {
  if (isTrimming && draggedBar) {
    saveToHistory(draggedBar.type, {
      musicBar: { ...musicBar },
      brollBars: brollBars.map(b => ({ ...b }))
    });
    isTrimming = false;
    trimSide = null;
    draggedBar = null;
    document.removeEventListener('mousemove', handleTrimMove);
    document.removeEventListener('touchmove', handleTrimMove);
    document.removeEventListener('mouseup', handleTrimEnd);
    document.removeEventListener('touchend', handleTrimEnd);
  }
}

function saveToHistory(type, state) {
  history = history.slice(0, historyIndex + 1);
  history.push({ type, state });
  historyIndex++;
}

function undo() {
  if (historyIndex > 0) {
    historyIndex--;
    const prevState = history[historyIndex];
    musicBar = { ...prevState.state.musicBar };
    brollBars = prevState.state.brollBars ? prevState.state.brollBars.map(b => ({ ...b })) : [];
    updateMusicBar();
    updateBrollBars();
    deselectBroll();
  }
}

function redo() {
  if (historyIndex < history.length - 1) {
    historyIndex++;
    const nextState = history[historyIndex];
    musicBar = { ...nextState.state.musicBar };
    brollBars = prevState.state.brollBars ? prevState.state.brollBars.map(b => ({ ...b })) : [];
    updateMusicBar();
    updateBrollBars();
    deselectBroll();
  }
}

function deleteBroll() {
  if (selectedBroll) {
    const index = parseInt(selectedBroll.dataset.index);
    brollBars.splice(index, 1);
    saveToHistory('broll', {
      musicBar: { ...musicBar },
      brollBars: brollBars.map(b => ({ ...b }))
    });
    updateBrollBars();
    deselectBroll();
  }
}

// Preview Main
function initializePreviewMain() {
  const orientationToggle = document.getElementById('orientation-toggle');
  const videoContainer = document.getElementById('preview-video-container');
  const video = document.getElementById('preview-video');
  const playPause = document.getElementById('control-play-pause');
  const backward = document.getElementById('control-backward');
  const forward = document.getElementById('control-forward');
  const previous = document.getElementById('control-previous');
  const next = document.getElementById('control-next');
  const timeline = document.getElementById('timeline');
  const drag = document.getElementById('timeline-drag');
  const addImage = document.getElementById('add-image');
  const generateButton = document.getElementById('generate-button');
  const paymentAlert = document.getElementById('payment-alert');
  const paymentGenerate = document.getElementById('payment-generate');
  const troubleCancel = document.getElementById('trouble-cancel');
  const troubleRetry = document.getElementById('trouble-retry');
  const undoBtn = document.getElementById('undo');
  const redoBtn = document.getElementById('redo');
  const trashBtn = document.getElementById('trash');
  const zoomOutBtn = document.getElementById('zoomout');
  const zoomInBtn = document.getElementById('zoomin');
  const expandBtn = document.getElementById('expand');

  orientationToggle.addEventListener('click', () => {
    isLandScape = !isLandScape;
    document.getElementById('orientation-text').textContent = isLandScape ? 'Landscape' : 'Portrait';
    applyVideoEffects();
  });

  playPause.addEventListener('click', handlePlayPause);
  backward.addEventListener('click', handleBackward10s);
  forward.addEventListener('click', handleForward10s);
  previous.addEventListener('click', handlePrevious);
  next.addEventListener('click', handleNext);
  addImage.addEventListener('change', handleAddImage);
  generateButton.addEventListener('click', handleGenerateClick);
  paymentAlert.addEventListener('click', () => {
    showPaymentAlert = false;
    paymentAlert.classList.remove('show');
  });
  paymentGenerate.addEventListener('click', (e) => {
    e.stopPropagation();
    handlePaymentConfirmed();
  });
  troubleCancel.addEventListener('click', handleCancel);
  troubleRetry.addEventListener('click', handleRetry);

  drag.addEventListener('mousedown', handleStart);
  drag.addEventListener('touchstart', handleStart, { passive: false });

  undoBtn.addEventListener('click', undo);
  redoBtn.addEventListener('click', redo);
  trashBtn.addEventListener('click', deleteBroll);
  zoomOutBtn.addEventListener('click', () => {
    zoomLevel = Math.max(minZoom, zoomLevel - 0.5);
    updateTimelineRuler();
  });
  zoomInBtn.addEventListener('click', () => {
    zoomLevel = Math.min(maxZoom, zoomLevel + 0.5);
    updateTimelineRuler();
  });
  expandBtn.addEventListener('click', () => {
    isTimelineExpanded = !isTimelineExpanded;
    document.querySelector('.preview-timeline').style.paddingBottom = isTimelineExpanded ? '100px' : '';
    updateTimelineRuler();
  });

  video.addEventListener('timeupdate', () => {
    currentTime = video.currentTime;
    if (!isDragging) {
      splitPosition = (currentTime / duration) * 100;
      updateTimeline();
    }
    updateTimeDisplay();
  });

  video.addEventListener('loadedmetadata', () => {
    duration = video.duration;
    updateTimeDisplay();
    updateTimelineRuler();
    updateMusicBar();
    updateBrollBars();
  });

  document.addEventListener('mousemove', handleMove);
  document.addEventListener('mouseup', handleEnd);
  document.addEventListener('touchmove', handleMove, { passive: false });
  document.addEventListener('touchend', handleEnd);
}

function formatTime(time) {
  const minutes = Math.floor(time / 60);
  const seconds = Math.floor(time % 60);
  const milliseconds = Math.floor((time % 1) * 100);
  return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
}

function handlePlayPause() {
  const video = document.getElementById('preview-video');
  if (isplay) {
    video.pause();
  } else {
    video.play();
  }
  isplay = !isplay;
  document.getElementById('control-play-pause').src = isplay ? '../assets/images/pause.png' : '../assets/images/play1.png';
}

function handleForward10s() {
  const video = document.getElementById('preview-video');
  video.currentTime = Math.min(video.duration, video.currentTime + 10);
}

function handleBackward10s() {
  const video = document.getElementById('preview-video');
  video.currentTime = Math.max(0, video.currentTime - 10);
}

function handleNext() {
  const video = document.getElementById('preview-video');
  const chapterLength = 30;
  const nextChapter = Math.ceil(video.currentTime / chapterLength) * chapterLength;
  video.currentTime = Math.min(video.duration, nextChapter);
}

function handlePrevious() {
  const video = document.getElementById('preview-video');
  const chapterLength = 30;
  const prevChapter = Math.floor(video.currentTime / chapterLength) * chapterLength - chapterLength;
  video.currentTime = Math.max(0, prevChapter);
}

function handleAddImage(e) {
  const file = e.target.files[0];
  if (file) {
    const name = file.name;
    const url = URL.createObjectURL(file);
    brollBars.push({ start: 0, end: Math.min(5, duration || 20), name, url });
    saveToHistory('broll', {
      musicBar: { ...musicBar },
      brollBars: brollBars.map(b => ({ ...b }))
    });
    updateBrollBars();
  }
}

function generateThumbnails() {
  const video = document.getElementById('preview-video');
  const canvas = document.getElementById('thumbnail-canvas');
  const context = canvas.getContext('2d');
  const numThumbnails = 15;
  const newThumbnails = [];

  if (!avatar.video) {
    updateTimelineGrid();
    return;
  }

  video.src = avatar.video;
  video.load();

  video.onloadedmetadata = () => {
    duration = video.duration;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const interval = duration / (numThumbnails + 1);
    let index = 1;

    function generateNextThumbnail() {
      if (index > numThumbnails) {
        thumbnails = newThumbnails;
        updateTimelineGrid();
        return;
      }

      const seekTime = interval * index;
      video.currentTime = seekTime;

      video.onseeked = () => {
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        newThumbnails.push(canvas.toDataURL('image/png'));
        index++;
        video.onseeked = null;
        generateNextThumbnail();
      };

      video.onerror = () => {
        console.error('Failed to seek video');
        index++;
        generateNextThumbnail();
      };
    }

    generateNextThumbnail();
  };
}

function updateTimelineGrid() {
  const container = document.getElementById('timeline-grid');
  if (thumbnails.length > 0) {
    container.innerHTML = thumbnails.map((src, index) => `
      <div><img src="${src}" alt="frame-${index}"></div>
    `).join('');
  } else {
    container.innerHTML = Array(15).fill().map((_, index) => `
      <div class="preview-timeline-grid-placeholder"></div>
    `).join('');
  }
}

function updateTimeline() {
  const drag = document.getElementById('timeline-drag');
  drag.style.left = `${splitPosition}%`;
}

function updateTimeDisplay() {
  document.getElementById('current-time').textContent = formatTime(currentTime);
  document.getElementById('duration').textContent = formatTime(duration);
}

function handleMove(e) {
  if (isDragging) {
    const timeline = document.getElementById('timeline');
    const video = document.getElementById('preview-video');
    const rect = timeline.getBoundingClientRect();
    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
    const newX = clientX - rect.left;
    const newPosition = (newX / rect.width) * 100;
    const clampedPosition = Math.max(0, Math.min(100, newPosition));
    splitPosition = clampedPosition;
    video.currentTime = (clampedPosition / 100) * video.duration;
    currentTime = video.currentTime;
    updateTimeline();
    updateTimeDisplay();
    if (isplay) {
      video.pause();
      isplay = false;
      document.getElementById('control-play-pause').src = '../assets/images/play1.png';
    }
  }
}

function handleStart(e) {
  e.preventDefault();
  isDragging = true;
}

function handleEnd() {
  isDragging = false;
}

function handleGenerateClick() {
  showPaymentAlert = true;
  document.getElementById('payment-alert').classList.add('show');
}

function handlePaymentConfirmed() {
  showPaymentAlert = false;
  document.getElementById('payment-alert').classList.remove('show');
  generating = true;
  document.getElementById('generating-overlay').classList.add('show');
  animateProgressBar();
  setTimeout(() => {
    generating = false;
    document.getElementById('generating-overlay').classList.remove('show');
    const success = Math.random() > 0.2;
    if (success) {
      window.location.href = './avatar.html';
    } else {
      error = true;
      document.getElementById('trouble-overlay').classList.add('show');
    }
  }, 3000);
}

function animateProgressBar() {
  const progressBar = document.getElementById('generating-progress-bar');
  let progress = 0;
  const interval = setInterval(() => {
    if (progress >= 100 || !generating) {
      clearInterval(interval);
    } else {
      progress += 100 / (3000 / 50);
      progressBar.style.width = `${progress}%`;
    }
  }, 50);
}

function handleRetry() {
  error = false;
  document.getElementById('trouble-overlay').classList.remove('show');
  generating = true;
  document.getElementById('generating-overlay').classList.add('show');
  animateProgressBar();
  setTimeout(() => {
    generating = false;
    document.getElementById('generating-overlay').classList.remove('show');
    window.location.href = './avatar.html';
  }, 3000);
}

function handleCancel() {
  error = false;
  generating = false;
  document.getElementById('trouble-overlay').classList.remove('show');
  document.getElementById('generating-overlay').classList.remove('show');
}
  </script>
</body>
</html>
